WITH BASE AS (
    SELECT EXTRACT(YEAR FROM S.SALES_DATE) AS SALES_YEAR
         , SUM(S.NET_AMOUNT) AS TOTAL_SALES
         , SUM(S.QTY) AS TOTAL_QTY
         , COUNT(DISTINCT S.SALES_ID) AS ORDER_CNT
         , SUM(P.TARGET_QTY * P.TARGET_AMT) AS TARGET_SALES
      FROM SM_SALES_PERFORMANCE S
      LEFT JOIN SM_SALES_PLAN P
        ON S.PROD_ID = P.PROD_ID
     WHERE EXTRACT(YEAR FROM S.SALES_DATE) IN (:VS_YEAR, :VS_YEAR - 1)
     GROUP BY EXTRACT(YEAR FROM S.SALES_DATE)
),
CALC AS (
    SELECT SALES_YEAR
         , TOTAL_SALES
         , TOTAL_QTY
         , TOTAL_SALES / NULLIF(ORDER_CNT, 0) AS AVG_ORDER_AMOUNT
         , TOTAL_SALES / NULLIF(TARGET_SALES, 0) AS ACHIEVEMENT_RATE
      FROM BASE
)
SELECT CURR.TOTAL_SALES AS TOTAL_SALES
     , (CURR.TOTAL_SALES - PREV.TOTAL_SALES) / NULLIF(PREV.TOTAL_SALES, 0) AS TOTAL_SALES_YOY
     , CURR.TOTAL_QTY AS TOTAL_QTY
     , (CURR.TOTAL_QTY - PREV.TOTAL_QTY) * 1.0 / NULLIF(PREV.TOTAL_QTY, 0) AS TOTAL_QTY_YOY
     , CURR.AVG_ORDER_AMOUNT AS AVG_ORDER_AMOUNT
     , (CURR.AVG_ORDER_AMOUNT - PREV.AVG_ORDER_AMOUNT) / NULLIF(PREV.AVG_ORDER_AMOUNT, 0) AS AVG_ORDER_AMOUNT_YOY
     , CURR.ACHIEVEMENT_RATE AS ACHIEVEMENT_RATE
     , (CURR.ACHIEVEMENT_RATE - PREV.ACHIEVEMENT_RATE) / NULLIF(PREV.ACHIEVEMENT_RATE, 0) AS ACHIEVEMENT_RATE_YOY
  FROM CALC CURR
  JOIN CALC PREV
    ON PREV.SALES_YEAR = CURR.SALES_YEAR - 1
 WHERE CURR.SALES_YEAR = :VS_YEAR;