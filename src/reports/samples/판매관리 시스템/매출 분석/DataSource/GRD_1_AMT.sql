SELECT DATE
     , ACTUAL
     , TARGET
     , ACTUAL/NULLIF(TARGET, 0) AS RATE
     , CASE
         WHEN ACTUAL > PREV_ACTUAL THEN 'ðŸ“ˆ'
         WHEN ACTUAL < PREV_ACTUAL THEN 'ðŸ“‰'
         ELSE ''
       END AS TREND
FROM (
    SELECT TO_CHAR(PFM.SALES_DATE,'YYYYMM') AS DATE
         , SUM(PFM.NET_AMOUNT) AS ACTUAL
         , SUM(PLN.TARGET_AMT) AS TARGET
         , LAG(SUM(PFM.NET_AMOUNT)) OVER (ORDER BY TO_CHAR(PFM.SALES_DATE,'YYYYMM')) AS PREV_ACTUAL
      FROM SM_SALES_PERFORMANCE PFM
      LEFT JOIN SM_SALES_PLAN PLN
        ON PFM.PROD_ID = PLN.PROD_ID
	    AND TO_CHAR(PFM.SALES_DATE, 'YYYY') = PLN.PLAN_YEAR
		AND TO_CHAR(PFM.SALES_DATE, 'MM') = PLN.PLAN_MONTH
     WHERE TO_CHAR(PFM.SALES_DATE,'YYYY') = :VS_YEAR
	 
     GROUP BY TO_CHAR(PFM.SALES_DATE,'YYYYMM')
) T
ORDER BY DATE