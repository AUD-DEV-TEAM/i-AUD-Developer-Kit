SELECT
      ROW_NUMBER() OVER (ORDER BY SUM(PERF.NET_AMOUNT) DESC) AS RANK
    , E.EMP_NAME AS EMP_NAME
	, D.DEPT_NAME AS DEPT_NAME
    , SUM(PERF.NET_AMOUNT) AS NET_AMOUNT_SUM
    , CASE
        WHEN SUM(PLN.TARGET_AMT) = 0 THEN 0
        ELSE SUM(PERF.NET_AMOUNT) / NULLIF(SUM(PLN.TARGET_AMT), 0)
      END AS RATE
 FROM SM_SALES_PLAN PLN
 LEFT JOIN SM_SALES_PERFORMANCE PERF
   ON PLN.PROD_ID = PERF.PROD_ID
 LEFT JOIN SM_EMPLOYEE E
   ON PLN.EMP_ID = E.EMP_ID
 LEFT JOIN SM_DEPARTMENT D
   ON E.DEPT_ID = D.DEPT_ID
WHERE 1=1
  AND TO_CHAR(PERF.SALES_DATE, 'YYYY') = :VS_YEAR
GROUP BY
      E.EMP_NAME
	, D.DEPT_NAME
LIMIT 10